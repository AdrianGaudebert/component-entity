!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.ensy=e()}(this,function(){"use strict";function t(e){if(null==e||"object"!=("undefined"==typeof e?"undefined":n(e)))return e;var o;if(e instanceof Date)return o=new Date,o.setTime(e.getTime()),o;if(e instanceof Array){o=[];for(var i=0,r=e.length;i<r;i++)o[i]=t(e[i]);return o}if(e instanceof Object){o={};for(var s in e)e.hasOwnProperty(s)&&(o[s]=t(e[s]));return o}}function e(t){return t&&"[object Function]"==={}.toString.call(t)}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=(function(){function t(t){this.value=t}function e(e){function n(t,e){return new Promise(function(n,i){var a={key:t,arg:e,resolve:n,reject:i,next:null};s?s=s.next=a:(r=s=a,o(t,e))})}function o(n,r){try{var s=e[n](r),a=s.value;a instanceof t?Promise.resolve(a.value).then(function(t){o("next",t)},function(t){o("throw",t)}):i(s.done?"return":"normal",s.value)}catch(t){i("throw",t)}}function i(t,e){switch(t){case"return":r.resolve({value:e,done:!0});break;case"throw":r.reject(e);break;default:r.resolve({value:e,done:!1})}r=r.next,r?o(r.key,r.arg):s=null}var r,s;this._invoke=n,"function"!=typeof e.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)},{wrap:function(t){return function(){return new e(t.apply(this,arguments))}},await:function(e){return new t(e)}}}(),function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}),i=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),r=function(){function n(t){o(this,n),this.listener=null,t&&e(t.emit)&&(this.listener=t),this.entities=[],this.components={},this.assemblages={},this.entityComponentData={},this.processors=[],this.uid=0}return i(n,[{key:"getUid",value:function(){return this.uid++}},{key:"createEntity",value:function(t,e){return"undefined"==typeof e||null===e?e=this.getUid():e>this.uid&&(this.uid=e),this.addComponentsToEntity(t,e),this.entities.includes(e)||this.entities.push(e),this.listener&&this.listener.emit("entityCreated",e),e}},{key:"removeEntity",value:function(t){for(var e in this.entityComponentData)this.entityComponentData.hasOwnProperty(e)&&this.entityComponentData[e][t]&&delete this.entityComponentData[e][t];return this.entities.splice(this.entities.indexOf(t),1),this.listener&&this.listener.emit("entityCreated",t),this}},{key:"addComponent",value:function(t,e){return this.components[t]=e,this}},{key:"removeComponent",value:function(t){return delete this.components[t],delete this.entityComponentData[t],this}},{key:"getComponentsList",value:function(){return Object.keys(this.components)}},{key:"addComponentsToEntity",value:function(e,n){var o,i,r=this;for(o=e.length-1;o>=0;o--)if(i=e[o],!this.components[i])throw new Error("Trying to use unknown component: "+i);for(o=e.length-1;o>=0;o--){i=e[o],this.entityComponentData[i]||(this.entityComponentData[i]={});var s=null;r.listener?(s={},function(e){var o=t(r.components[i].state);for(var s in o)o.hasOwnProperty(s)&&!function(t){Object.defineProperty(e,t,{get:function(){return o[t]},set:function(e){o[t]=e,r.listener.emit("entityComponentUpdated",n,i)}})}(s)}(s),r.listener.emit("entityComponentAdded",n,i)):s=t(r.components[i].state),s.__id=n,this.entityComponentData[i][n]=s}return this}},{key:"removeComponentsFromEntity",value:function(t,e){var n,o;for(n=t.length-1;n>=0;n--)if(o=t[n],!this.components[o])throw new Error("Trying to use unknown component: "+o);for(n=t.length-1;n>=0;n--)o=t[n],this.entityComponentData[o]&&this.entityComponentData[o][e]&&(delete this.entityComponentData[o][e],this.listener&&this.listener.emit("entityComponentRemoved",e,o));return this}},{key:"getComponentDataForEntity",value:function(t,e){if(!(t in this.components))throw new Error("Trying to use unknown component: "+t);if(!this.entityComponentData.hasOwnProperty(t)||!this.entityComponentData[t].hasOwnProperty(e))throw new Error("No data for component "+t+" and entity "+e);return this.entityComponentData[t][e]}},{key:"updateComponentDataForEntity",value:function(t,e,n){var o=this.getComponentDataForEntity(t,e);for(var i in n)n.hasOwnProperty(i)&&o.hasOwnProperty(i)&&(o[i]=n[i]);return this}},{key:"getComponentsData",value:function(t){if(!(t in this.components))throw new Error("Trying to use unknown component: "+t);return this.entityComponentData.hasOwnProperty(t)?this.entityComponentData[t]:[]}},{key:"entityHasComponent",value:function(t,e){return e in this.components&&(this.entityComponentData.hasOwnProperty(e)&&this.entityComponentData[e].hasOwnProperty(t))}},{key:"addAssemblage",value:function(t,e){return this.assemblages[t]=e,this}},{key:"removeAssemblage",value:function(t){return delete this.assemblages[t],this}},{key:"createEntityFromAssemblage",value:function(t){if(!(t in this.assemblages))throw new Error("Trying to use unknown assemblage: "+t);var e=this.assemblages[t],n=this.createEntity(e.components);for(var o in e.initialState)if(e.initialState.hasOwnProperty(o)){var i=e.initialState[o];this.updateComponentDataForEntity(o,n,i)}return n}},{key:"addProcessor",value:function(t){return this.processors.push(t),this}},{key:"removeProcessor",value:function(t){return this.processors.splice(this.processors.indexOf(t),1),this}},{key:"update",value:function(t){for(var e=0;e<this.processors.length;e++)this.processors[e].update(t);return this}}]),n}();return r});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjpudWxsLCJzb3VyY2VzIjpbInNyYy9lbnRpdHktbWFuYWdlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIGVuc3kgLSBFbnRpdHkgU3lzdGVtIEphdmFTY3JpcHQgTGlicmFyeSB2MS4yLjFcbiAqXG4gKiBBIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24gb2YgdGhlIEVudGl0eSBTeXN0ZW0gbW9kZWwgYXMgZGVzY3JpYmVkIGJ5XG4gKiBBZGFtIE1hcnRpbiBpbiBodHRwOi8vdC1tYWNoaW5lLm9yZy9pbmRleC5waHAvMjAwOS8xMC8yNi9lbnRpdHktc3lzdGVtcy1hcmUtdGhlLWZ1dHVyZS1vZi1tbW9zLXBhcnQtNS9cbiAqXG4gKiBAYXV0aG9yIEFkcmlhbiBHYXVkZWJlcnQgLSBhZHJpYW5AZ2F1ZGViZXJ0LmZyXG4gKiBAbGljZW5zZSBNSVQgbGljZW5zZS5cbiAqXG4gKi9cblxuLyohXG4gKiBSZXR1cm4gYSBjbG9uZSBvZiBhbiBvYmplY3QuXG4gKiBGcm9tIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzcyODM2MFxuICovXG5mdW5jdGlvbiBjbG9uZShvYmopIHtcbiAgICAvLyBIYW5kbGUgdGhlIDMgc2ltcGxlIHR5cGVzLCBhbmQgbnVsbCBvciB1bmRlZmluZWRcbiAgICBpZiAobnVsbCA9PSBvYmogfHwgJ29iamVjdCcgIT0gdHlwZW9mIG9iaikgcmV0dXJuIG9iajtcblxuICAgIHZhciBjb3B5O1xuXG4gICAgLy8gSGFuZGxlIERhdGVcbiAgICBpZiAob2JqIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICBjb3B5ID0gbmV3IERhdGUoKTtcbiAgICAgICAgY29weS5zZXRUaW1lKG9iai5nZXRUaW1lKCkpO1xuICAgICAgICByZXR1cm4gY29weTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgQXJyYXlcbiAgICBpZiAob2JqIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgY29weSA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gb2JqLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgICAgICBjb3B5W2ldID0gY2xvbmUob2JqW2ldKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29weTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgT2JqZWN0XG4gICAgaWYgKG9iaiBpbnN0YW5jZW9mIE9iamVjdCkge1xuICAgICAgICBjb3B5ID0ge307XG4gICAgICAgIGZvciAodmFyIGF0dHIgaW4gb2JqKSB7XG4gICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGF0dHIpKSBjb3B5W2F0dHJdID0gY2xvbmUob2JqW2F0dHJdKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29weTtcbiAgICB9XG59XG5cbi8qIVxuICogUmV0dXJuIHRydWUgaWYgdGhlIHBhcmFtZXRlciBpcyBhIGZ1bmN0aW9uLlxuICogRnJvbSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81OTk5OTk4XG4gKi9cbmZ1bmN0aW9uIGlzRnVuY3Rpb24odGhpbmdUb0NoZWNrKSB7XG4gICAgcmV0dXJuIHRoaW5nVG9DaGVjayAmJiAoe30pLnRvU3RyaW5nLmNhbGwodGhpbmdUb0NoZWNrKSA9PT0gJ1tvYmplY3QgRnVuY3Rpb25dJztcbn1cblxuLyoqXG4gKiBAY2xhc3MgRW50aXR5TWFuYWdlclxuICpcbiAqIEltcGxlbWVudCB0aGUgRW50aXR5IFN5c3RlbSBtb2RlbCBhbmQgcHJvdmlkZSB0b29scyB0byBlYXNpbHlcbiAqIGNyZWF0ZSBhbmQgbWFuaXB1bGF0ZSBFbnRpdGllcywgQ29tcG9uZW50cyBhbmQgUHJvY2Vzc29ycy5cbiAqL1xuY2xhc3MgRW50aXR5TWFuYWdlciB7XG4gICAgY29uc3RydWN0b3IobGlzdGVuZXIpIHtcbiAgICAgICAgdGhpcy5saXN0ZW5lciA9IG51bGw7XG4gICAgICAgIGlmIChsaXN0ZW5lciAmJiBpc0Z1bmN0aW9uKGxpc3RlbmVyLmVtaXQpKSB7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyID0gbGlzdGVuZXI7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBIGxpc3Qgb2YgZW50aXR5IElEcywgZWFjaCBiZWluZyBhIHNpbXBsZSBpbnRlZ2VyLlxuICAgICAgICB0aGlzLmVudGl0aWVzID0gW107XG5cbiAgICAgICAgLy8gQSBkaWN0aW9uYXJ5IG9mIGNvbXBvbmVudHMsIHdoZXJlIGtleXMgYXJlIHRoZSBuYW1lIG9mIGVhY2hcbiAgICAgICAgLy8gY29tcG9uZW50LiBDb21wb25lbnRzIGFyZSBvYmplY3RzIGNvbnRhaW5pbmc6XG4gICAgICAgIC8vICAqIG1ldGFkYXRhIChuYW1lLCBkZXNjcmlwdGlvbilcbiAgICAgICAgLy8gICogdGhlIGluaXRpYWwgc2V0IG9mIGRhdGEgdGhhdCBkZWZpbmVzIHRoZSBkZWZhdWx0IHN0YXRlIG9mIGFcbiAgICAgICAgLy8gICAgbmV3bHkgaW5zdGFuY2lhdGVkIGNvbXBvbmVudFxuICAgICAgICB0aGlzLmNvbXBvbmVudHMgPSB7fTtcblxuICAgICAgICAvLyBBIGRpY3Rpb25hcnkgb2YgYXNzZW1ibGFnZXMsIHdoZXJlIGtleXMgYXJlIHRoZSBuYW1lIG9mIGVhY2hcbiAgICAgICAgLy8gYXNzZW1ibGFnZS4gQXNzZW1ibGFnZXMgYXJlIG9iamVjdHMgY29udGFpbmluZzpcbiAgICAgICAgLy8gICogbWV0YWRhdGEgKG5hbWUsIGRlc2NyaXB0aW9uKVxuICAgICAgICAvLyAgKiBhIGxpc3Qgb2YgY29tcG9uZW50cyB0byBhZGQgdG8gdGhlIGVudGl0eVxuICAgICAgICAvLyAgKiBhbiBpbml0aWFsIHN0YXRlIGZvciBzb21lIGNvbXBvbmVudHMsIHRvIG92ZXJyaWRlIHRoZSBkZWZhdWx0c1xuICAgICAgICB0aGlzLmFzc2VtYmxhZ2VzID0ge307XG5cbiAgICAgICAgLyohXG4gICAgICAgICAqIEEgcmVsYXRpb25hbC1saWtlIGxpc3Qgb2YgZW50aXR5IHN0YXRlcy4gVGhlcmUgaXMgb25lIGxpbmUgZm9yXG4gICAgICAgICAqIGVhY2ggZW50aXR5IC0gY29tcG9uZW50IGFzc29jaWF0aW9uLlxuICAgICAgICAgKlxuICAgICAgICAgKiBUbyBvcHRpbWl6ZSB0aGUgYWNjZXNzIHRpbWUgdG8gdGhpcyBkYXRhLCBpdCBpcyBzdG9yZWQgaW4gYVxuICAgICAgICAgKiBkaWN0aW9uYXJ5IG9mIGRpY3Rpb25hcmllcyBvZiB0aGlzIGZvcm06XG4gICAgICAgICAqIHtcbiAgICAgICAgICogICBcImNvbXBvbmVudElkXCI6IHtcbiAgICAgICAgICogICAgIFwiZW50aXR5SWRcIjoge1xuICAgICAgICAgKiAgICAgICAuLi5cbiAgICAgICAgICogICAgICAgaGVyZSBjb21lcyB0aGUgc3RhdGUgb2YgdGhpcyBlbnRpdHkgZm9yIHRoaXMgY29tcG9uZW50XG4gICAgICAgICAqICAgICAgIC4uLlxuICAgICAgICAgKiAgICAgfVxuICAgICAgICAgKiAgIH1cbiAgICAgICAgICogfVxuICAgICAgICAgKlxuICAgICAgICAgKiBUaGlzIHdheSwgZ2V0dGluZyB0aGUgZGF0YSBvZiBvbmUgZW50aXR5IGZvciBvbmUgY29tcG9uZW50IGlzOlxuICAgICAgICAgKiAgIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wb25lbnRJZF1bZW50aXR5SWRdXG4gICAgICAgICAqIGFuZCBnZXR0aW5nIGFsbCBlbnRpdGllcyBmb3Igb25lIGNvbXBvbmVudCBpczpcbiAgICAgICAgICogICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcG9uZW50SWRdXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGEgPSB7fTtcblxuICAgICAgICAvLyBUaGUgb3JkZXJlZCBsaXN0IG9mIHByb2Nlc3NvcnMga25vd24gYnkgdGhpcyBtYW5hZ2VyLlxuICAgICAgICB0aGlzLnByb2Nlc3NvcnMgPSBbXTtcblxuICAgICAgICAvLyBUaGUgbmV4dCB1bmlxdWUgaWRlbnRpZmllci5cbiAgICAgICAgdGhpcy51aWQgPSAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhbiBpZGVudGlmaWVyIHVuaXF1ZSB0byB0aGlzIHN5c3RlbS5cbiAgICAgKlxuICAgICAqIEByZXR1cm4ge2ludH0gLSBVbmlxdWUgaWRlbnRpZmllci5cbiAgICAgKi9cbiAgICBnZXRVaWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnVpZCsrO1xuICAgIH1cblxuICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIEVOVElUSUVTXG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5IGluIHRoZSBzeXN0ZW0gYnkgY3JlYXRpbmcgYSBuZXcgaW5zdGFuY2Ugb2YgZWFjaCBvZlxuICAgICAqIGl0cyBjb21wb25lbnRzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHthcnJheX0gY29tcG9uZW50SWRzIC0gTGlzdCBvZiBpZGVudGlmaWVycyBvZiB0aGUgY29tcG9uZW50cyB0aGF0IGNvbXBvc2UgdGhlIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gT3B0aW9uYWwuIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBlbnRpdHkuIElmIHBhc3NlZCwgbm8gbmV3IGlkIHdpbGwgYmUgZ2VuZXJhdGVkLlxuICAgICAqIEByZXR1cm4ge2ludH0gLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbmV3IGVudGl0eS5cbiAgICAgKi9cbiAgICBjcmVhdGVFbnRpdHkoY29tcG9uZW50SWRzLCBlbnRpdHlJZCkge1xuICAgICAgICBpZiAodHlwZW9mIGVudGl0eUlkID09PSAndW5kZWZpbmVkJyB8fCBlbnRpdHlJZCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgZW50aXR5SWQgPSB0aGlzLmdldFVpZCgpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGVudGl0eUlkID4gdGhpcy51aWQpIHtcbiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSBhbm90aGVyIGVudGl0eSB3aXRoIHRoZSBzYW1lIElEIHdvbid0IGJlIGNyZWF0ZWQgaW4gdGhlIGZ1dHVyZS5cbiAgICAgICAgICAgIHRoaXMudWlkID0gZW50aXR5SWQ7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmFkZENvbXBvbmVudHNUb0VudGl0eShjb21wb25lbnRJZHMsIGVudGl0eUlkKTtcbiAgICAgICAgaWYgKCF0aGlzLmVudGl0aWVzLmluY2x1ZGVzKGVudGl0eUlkKSkge1xuICAgICAgICAgICAgdGhpcy5lbnRpdGllcy5wdXNoKGVudGl0eUlkKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5saXN0ZW5lcikge1xuICAgICAgICAgICAgLy8gU2lnbmFsIHRoZSBjcmVhdGlvbiBvZiBhIG5ldyBlbnRpdHkuXG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLmVtaXQoJ2VudGl0eUNyZWF0ZWQnLCBlbnRpdHlJZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVudGl0eUlkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBlbnRpdHkgYW5kIGl0cyBpbnN0YW5jaWF0ZWQgY29tcG9uZW50cyBmcm9tIHRoZSBzeXN0ZW0uXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ludH0gaWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgZW50aXR5LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgcmVtb3ZlRW50aXR5KGlkKSB7XG4gICAgICAgIC8vIFJlbW92ZSBhbGwgZGF0YSBmb3IgdGhpcyBlbnRpdHkuXG4gICAgICAgIGZvciAodmFyIGNvbXAgaW4gdGhpcy5lbnRpdHlDb21wb25lbnREYXRhKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5lbnRpdHlDb21wb25lbnREYXRhLmhhc093blByb3BlcnR5KGNvbXApKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXVtpZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXVtpZF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmVtb3ZlIHRoZSBlbnRpdHkgZnJvbSB0aGUgbGlzdCBvZiBrbm93biBlbnRpdGllcy5cbiAgICAgICAgdGhpcy5lbnRpdGllcy5zcGxpY2UodGhpcy5lbnRpdGllcy5pbmRleE9mKGlkKSwgMSk7XG5cbiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXIpIHtcbiAgICAgICAgICAgIC8vIFNpZ25hbCB0aGUgcmVtb3ZhbCBvZiBhbiBlbnRpdHkuXG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLmVtaXQoJ2VudGl0eUNyZWF0ZWQnLCBpZCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyBDT01QT05FTlRTXG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBjb21wb25lbnQgdG8gdGhlIGxpc3Qgb2Yga25vd24gY29tcG9uZW50cy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBjb21wb25lbnQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbXBvbmVudCAtIE9iamVjdCBjb250YWluaW5nIHRoZSBtZXRhZGF0YSBhbmQgZGF0YSBvZiB0aGUgY29tcG9uZW50LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgYWRkQ29tcG9uZW50KGlkLCBjb21wb25lbnQpIHtcbiAgICAgICAgdGhpcy5jb21wb25lbnRzW2lkXSA9IGNvbXBvbmVudDtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGEgY29tcG9uZW50IGZyb20gdGhlIGxpc3Qgb2Yga25vd24gY29tcG9uZW50cy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBjb21wb25lbnQuXG4gICAgICogQHJldHVybiB7b2JqZWN0fSAtIHRoaXNcbiAgICAgKi9cbiAgICByZW1vdmVDb21wb25lbnQoaWQpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuY29tcG9uZW50c1tpZF07XG4gICAgICAgIGRlbGV0ZSB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbaWRdO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGxpc3Qgb2YgY29tcG9uZW50cyB0aGlzIGluc3RhbmNlIGtub3dzLlxuICAgICAqXG4gICAgICogQHJldHVybiB7YXJyYXl9IC0gTGlzdCBvZiBuYW1lcyBvZiBjb21wb25lbnRzLlxuICAgICAqL1xuICAgIGdldENvbXBvbmVudHNMaXN0KCkge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5jb21wb25lbnRzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgZWFjaCBsaXN0ZWQgY29tcG9uZW50IGFuZCBhc3NvY2lhdGUgdGhlbVxuICAgICAqIHdpdGggdGhlIGVudGl0eS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGNvbXBvbmVudElkcyAtIExpc3Qgb2YgaWRlbnRpZmllcnMgb2YgdGhlIGNvbXBvbmVudHMgdG8gYWRkIHRvIHRoZSBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGVudGl0eS5cbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IC0gdGhpc1xuICAgICAqL1xuICAgIGFkZENvbXBvbmVudHNUb0VudGl0eShjb21wb25lbnRJZHMsIGVudGl0eUlkKSB7XG4gICAgICAgIHZhciBpO1xuICAgICAgICB2YXIgY29tcDtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIC8vIEZpcnN0IHZlcmlmeSB0aGF0IGFsbCB0aGUgY29tcG9uZW50cyBleGlzdCwgYW5kIHRocm93IGFuIGVycm9yXG4gICAgICAgIC8vIGlmIGFueSBpcyB1bmtub3duLlxuICAgICAgICBmb3IgKGkgPSBjb21wb25lbnRJZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgIGNvbXAgPSBjb21wb25lbnRJZHNbaV07XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5jb21wb25lbnRzW2NvbXBdKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gdXNlIHVua25vd24gY29tcG9uZW50OiAnICsgY29tcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBOb3cgd2Uga25vdyB0aGF0IHRoaXMgcmVxdWVzdCBpcyBjb3JyZWN0LCBsZXQncyBjcmVhdGUgdGhlIG5ld1xuICAgICAgICAvLyBlbnRpdHkgYW5kIGluc3RhbmNpYXRlIHRoZSBjb21wb25lbnQncyBzdGF0ZXMuXG4gICAgICAgIGZvciAoaSA9IGNvbXBvbmVudElkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICAgICAgY29tcCA9IGNvbXBvbmVudElkc1tpXTtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcF0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcF0gPSB7fTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIG5ld0NvbXBTdGF0ZSA9IG51bGw7XG5cbiAgICAgICAgICAgIC8vIElmIHRoZSBtYW5hZ2VyIGhhcyBhIGxpc3RlbmVyLCB3ZSB3YW50IHRvIGNyZWF0ZSBnZXR0ZXJzXG4gICAgICAgICAgICAvLyBhbmQgc2V0dGVycyBzbyB0aGF0IHdlIGNhbiBlbWl0IHN0YXRlIGNoYW5nZXMuIEJ1dCBpZiBpdCBkb2VzXG4gICAgICAgICAgICAvLyBub3QgaGF2ZSBvbmUsIHRoZXJlIGlzIG5vIG5lZWQgdG8gYWRkIHRoZSBvdmVyaGVhZC5cbiAgICAgICAgICAgIGlmIChzZWxmLmxpc3RlbmVyKSB7XG4gICAgICAgICAgICAgICAgbmV3Q29tcFN0YXRlID0ge307XG4gICAgICAgICAgICAgICAgKGZ1bmN0aW9uIChuZXdDb21wU3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gY2xvbmUoc2VsZi5jb21wb25lbnRzW2NvbXBdLnN0YXRlKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgYSBzZXR0ZXIgZm9yIGVhY2ggc3RhdGUgYXR0cmlidXRlLCBzbyB3ZSBjYW4gZW1pdCBhblxuICAgICAgICAgICAgICAgICAgICAvLyBldmVudCB3aGVuZXZlciB0aGUgc3RhdGUgb2YgdGhpcyBjb21wb25lbnQgY2hhbmdlcy5cbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHkgaW4gc3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKHByb3BlcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuZXdDb21wU3RhdGUsIHByb3BlcnR5LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGVbcHJvcGVydHldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlW3Byb3BlcnR5XSA9IHZhbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxpc3RlbmVyLmVtaXQoJ2VudGl0eUNvbXBvbmVudFVwZGF0ZWQnLCBlbnRpdHlJZCwgY29tcCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KShwcm9wZXJ0eSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KShuZXdDb21wU3RhdGUpO1xuXG4gICAgICAgICAgICAgICAgLy8gU2lnbmFsIHRoZSBhZGRpdGlvbiBvZiBhIG5ldyBjb21wb25lbnQgdG8gdGhlIGVudGl0eS5cbiAgICAgICAgICAgICAgICBzZWxmLmxpc3RlbmVyLmVtaXQoJ2VudGl0eUNvbXBvbmVudEFkZGVkJywgZW50aXR5SWQsIGNvbXApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgbmV3Q29tcFN0YXRlID0gY2xvbmUoc2VsZi5jb21wb25lbnRzW2NvbXBdLnN0YXRlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gU3RvcmUgdGhlIGVudGl0eSdzIElEIHNvIGl0J3MgZWFzaWVyIHRvIGZpbmQgb3RoZXIgY29tcG9uZW50cyBmb3IgdGhhdCBlbnRpdHkuXG4gICAgICAgICAgICBuZXdDb21wU3RhdGUuX19pZCA9IGVudGl0eUlkO1xuXG4gICAgICAgICAgICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcF1bZW50aXR5SWRdID0gbmV3Q29tcFN0YXRlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGUtYXNzb2NpYXRlIGEgbGlzdCBvZiBjb21wb25lbnRzIGZyb20gdGhlIGVudGl0eS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGNvbXBvbmVudElkcyAtIExpc3Qgb2YgaWRlbnRpZmllcnMgb2YgdGhlIGNvbXBvbmVudHMgdG8gcmVtb3ZlIGZyb20gdGhlIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge2ludH0gZW50aXR5SWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgZW50aXR5LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgcmVtb3ZlQ29tcG9uZW50c0Zyb21FbnRpdHkoY29tcG9uZW50SWRzLCBlbnRpdHlJZCkge1xuICAgICAgICB2YXIgaTtcbiAgICAgICAgdmFyIGNvbXA7XG5cbiAgICAgICAgLy8gRmlyc3QgdmVyaWZ5IHRoYXQgYWxsIHRoZSBjb21wb25lbnRzIGV4aXN0LCBhbmQgdGhyb3cgYW4gZXJyb3JcbiAgICAgICAgLy8gaWYgYW55IGlzIHVua25vd24uXG4gICAgICAgIGZvciAoaSA9IGNvbXBvbmVudElkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICAgICAgY29tcCA9IGNvbXBvbmVudElkc1tpXTtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLmNvbXBvbmVudHNbY29tcF0pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byB1c2UgdW5rbm93biBjb21wb25lbnQ6ICcgKyBjb21wKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE5vdyB3ZSBrbm93IHRoYXQgdGhpcyByZXF1ZXN0IGlzIGNvcnJlY3QsIGxldCdzIGNyZWF0ZSB0aGUgbmV3XG4gICAgICAgIC8vIGVudGl0eSBhbmQgaW5zdGFuY2lhdGUgdGhlIGNvbXBvbmVudCdzIHN0YXRlcy5cbiAgICAgICAgZm9yIChpID0gY29tcG9uZW50SWRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICBjb21wID0gY29tcG9uZW50SWRzW2ldO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5lbnRpdHlDb21wb25lbnREYXRhW2NvbXBdKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXVtlbnRpdHlJZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXVtlbnRpdHlJZF07XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxpc3RlbmVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBTaWduYWwgdGhlIGNyZWF0aW9uIG9mIGEgbmV3IGVudGl0eS5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXIuZW1pdCgnZW50aXR5Q29tcG9uZW50UmVtb3ZlZCcsIGVudGl0eUlkLCBjb21wKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIGEgcmVmZXJlbmNlIHRvIGFuIG9iamVjdCB0aGF0IGNvbnRhaW5zIHRoZSBkYXRhIG9mIGFuXG4gICAgICogaW5zdGFuY2lhdGVkIGNvbXBvbmVudCBvZiBhbiBlbnRpdHkuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ludH0gZW50aXR5SWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjb21wb25lbnRJZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBjb21wb25lbnQuXG4gICAgICogQHJldHVybiB7b2JqZWN0fSAtIENvbXBvbmVudCBkYXRhIG9mIG9uZSBlbnRpdHkuXG4gICAgICovXG4gICAgZ2V0Q29tcG9uZW50RGF0YUZvckVudGl0eShjb21wb25lbnRJZCwgZW50aXR5SWQpIHtcbiAgICAgICAgaWYgKCEoY29tcG9uZW50SWQgaW4gdGhpcy5jb21wb25lbnRzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gdXNlIHVua25vd24gY29tcG9uZW50OiAnICsgY29tcG9uZW50SWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgIXRoaXMuZW50aXR5Q29tcG9uZW50RGF0YS5oYXNPd25Qcm9wZXJ0eShjb21wb25lbnRJZCkgfHxcbiAgICAgICAgICAgICF0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcG9uZW50SWRdLmhhc093blByb3BlcnR5KGVudGl0eUlkKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gZGF0YSBmb3IgY29tcG9uZW50ICcgKyBjb21wb25lbnRJZCArICcgYW5kIGVudGl0eSAnICsgZW50aXR5SWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wb25lbnRJZF1bZW50aXR5SWRdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSB0aGUgc3RhdGUgb2YgYSBjb21wb25lbnQsIG1hbnkga2V5cyBhdCBvbmNlLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50SWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgY29tcG9uZW50LlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBuZXdTdGF0ZSAtIE9iamVjdCBjb250YWluaW5nIHRoZSBuZXcgc3RhdGUgdG8gYXBwbHkuXG4gICAgICogQHJldHVybiB7b2JqZWN0fSAtIHRoaXNcbiAgICAgKi9cbiAgICB1cGRhdGVDb21wb25lbnREYXRhRm9yRW50aXR5KGNvbXBvbmVudElkLCBlbnRpdHlJZCwgbmV3U3RhdGUpIHtcbiAgICAgICAgdmFyIGNvbXBTdGF0ZSA9IHRoaXMuZ2V0Q29tcG9uZW50RGF0YUZvckVudGl0eShjb21wb25lbnRJZCwgZW50aXR5SWQpO1xuXG4gICAgICAgIGZvciAodmFyIGtleSBpbiBuZXdTdGF0ZSkge1xuICAgICAgICAgICAgaWYgKG5ld1N0YXRlLmhhc093blByb3BlcnR5KGtleSkgJiYgY29tcFN0YXRlLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgICAgICBjb21wU3RhdGVba2V5XSA9IG5ld1N0YXRlW2tleV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gYSBsaXN0IG9mIG9iamVjdHMgY29udGFpbmluZyB0aGUgZGF0YSBvZiBhbGwgb2YgYSBnaXZlbiBjb21wb25lbnQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50SWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgY29tcG9uZW50LlxuICAgICAqIEByZXR1cm4ge2FycmF5fSAtIExpc3Qgb2YgY29tcG9uZW50IGRhdGEgZm9yIG9uZSBjb21wb25lbnQuXG4gICAgICovXG4gICAgZ2V0Q29tcG9uZW50c0RhdGEoY29tcG9uZW50SWQpIHtcbiAgICAgICAgaWYgKCEoY29tcG9uZW50SWQgaW4gdGhpcy5jb21wb25lbnRzKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gdXNlIHVua25vd24gY29tcG9uZW50OiAnICsgY29tcG9uZW50SWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLmVudGl0eUNvbXBvbmVudERhdGEuaGFzT3duUHJvcGVydHkoY29tcG9uZW50SWQpKSB7XG4gICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5lbnRpdHlDb21wb25lbnREYXRhW2NvbXBvbmVudElkXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdHJ1ZSBpZiB0aGUgZW50aXR5IGhhcyB0aGUgY29tcG9uZW50LlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50SWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgY29tcG9uZW50LlxuICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IC0gVHJ1ZSBpZiB0aGUgZW50aXR5IGhhcyB0aGUgY29tcG9uZW50LlxuICAgICAqL1xuICAgIGVudGl0eUhhc0NvbXBvbmVudChlbnRpdHlJZCwgY29tcG9uZW50SWQpIHtcbiAgICAgICAgaWYgKCEoY29tcG9uZW50SWQgaW4gdGhpcy5jb21wb25lbnRzKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YS5oYXNPd25Qcm9wZXJ0eShjb21wb25lbnRJZCkgJiZcbiAgICAgICAgICAgIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wb25lbnRJZF0uaGFzT3duUHJvcGVydHkoZW50aXR5SWQpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgLy8gQVNTRU1CTEFHRVNcblxuICAgIC8qKlxuICAgICAqIEFkZCBhbiBhc3NlbWJsYWdlIHRvIHRoZSBsaXN0IG9mIGtub3duIGFzc2VtYmxhZ2VzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGFzc2VtYmxhZ2UuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGFzc2VtYmxhZ2UgLSBBbiBpbnN0YW5jZSBvZiBhbiBhc3NlbWJsYWdlIHRvIGFkZC5cbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IC0gdGhpc1xuICAgICAqL1xuICAgIGFkZEFzc2VtYmxhZ2UoaWQsIGFzc2VtYmxhZ2UpIHtcbiAgICAgICAgdGhpcy5hc3NlbWJsYWdlc1tpZF0gPSBhc3NlbWJsYWdlO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYW4gYXNzZW1ibGFnZSBmcm9tIHRoZSBsaXN0IG9mIGtub3duIGFzc2VtYmxhZ2VzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGFzc2VtYmxhZ2UuXG4gICAgICogQHJldHVybiB7b2JqZWN0fSAtIHRoaXNcbiAgICAgKi9cbiAgICByZW1vdmVBc3NlbWJsYWdlKGlkKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmFzc2VtYmxhZ2VzW2lkXTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGVudGl0eSBpbiB0aGUgc3lzdGVtIGJ5IGNyZWF0aW5nIGEgbmV3IGluc3RhbmNlIG9mIGVhY2ggb2ZcbiAgICAgKiBpdHMgY29tcG9uZW50cyBhbmQgc2V0dGluZyB0aGVpciBpbml0aWFsIHN0YXRlLCB1c2luZyBhbiBhc3NlbWJsYWdlLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGFzc2VtYmxhZ2VJZCAtIElkIG9mIHRoZSBhc3NlbWJsYWdlIHRvIGNyZWF0ZSB0aGUgZW50aXR5IGZyb20uXG4gICAgICogQHJldHVybiB7aW50fSAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBuZXcgZW50aXR5LlxuICAgICAqL1xuICAgIGNyZWF0ZUVudGl0eUZyb21Bc3NlbWJsYWdlKGFzc2VtYmxhZ2VJZCkge1xuICAgICAgICBpZiAoIShhc3NlbWJsYWdlSWQgaW4gdGhpcy5hc3NlbWJsYWdlcykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHVzZSB1bmtub3duIGFzc2VtYmxhZ2U6ICcgKyBhc3NlbWJsYWdlSWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGFzc2VtYmxhZ2UgPSB0aGlzLmFzc2VtYmxhZ2VzW2Fzc2VtYmxhZ2VJZF07XG4gICAgICAgIHZhciBlbnRpdHkgPSB0aGlzLmNyZWF0ZUVudGl0eShhc3NlbWJsYWdlLmNvbXBvbmVudHMpO1xuXG4gICAgICAgIGZvciAodmFyIGNvbXAgaW4gYXNzZW1ibGFnZS5pbml0aWFsU3RhdGUpIHtcbiAgICAgICAgICAgIGlmIChhc3NlbWJsYWdlLmluaXRpYWxTdGF0ZS5oYXNPd25Qcm9wZXJ0eShjb21wKSkge1xuICAgICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGFzc2VtYmxhZ2UuaW5pdGlhbFN0YXRlW2NvbXBdO1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQ29tcG9uZW50RGF0YUZvckVudGl0eShjb21wLCBlbnRpdHksIG5ld1N0YXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgfVxuXG4gICAgLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgLy8gUFJPQ0VTU09SU1xuXG4gICAgLyoqXG4gICAgICogQWRkIGEgcHJvY2Vzc29yIHRvIHRoZSBsaXN0IG9mIGtub3duIHByb2Nlc3NvcnMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcHJvY2Vzc29yIC0gQW4gaW5zdGFuY2Ugb2YgYSBwcm9jZXNzb3IgdG8gbWFuYWdlLlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgYWRkUHJvY2Vzc29yKHByb2Nlc3Nvcikge1xuICAgICAgICB0aGlzLnByb2Nlc3NvcnMucHVzaChwcm9jZXNzb3IpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYSBwcm9jZXNzb3IgZnJvbSB0aGUgbGlzdCBvZiBrbm93biBwcm9jZXNzb3JzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHByb2Nlc3NvciAtIEFuIGluc3RhbmNlIG9mIGEgcHJvY2Vzc29yIHRvIHJlbW92ZS5cbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IC0gdGhpc1xuICAgICAqL1xuICAgIHJlbW92ZVByb2Nlc3Nvcihwcm9jZXNzb3IpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzb3JzLnNwbGljZSh0aGlzLnByb2Nlc3NvcnMuaW5kZXhPZihwcm9jZXNzb3IpLCAxKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFsbCB0aGUga25vd24gcHJvY2Vzc29ycy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW50fSBkdCAtIFRoZSB0aW1lIGRlbHRhIHNpbmNlIHRoZSBsYXN0IGNhbGwgdG8gdXBkYXRlLiBXaWxsIGJlIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byBhbGwgcHJvY2Vzc29yJ3MgYHVwZGF0ZWAgbWV0aG9kLlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgdXBkYXRlKGR0KSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wcm9jZXNzb3JzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NvcnNbaV0udXBkYXRlKGR0KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEVudGl0eU1hbmFnZXI7XG4iXSwibmFtZXMiOlsiY2xvbmUiLCJvYmoiLCJjb3B5IiwiRGF0ZSIsInNldFRpbWUiLCJnZXRUaW1lIiwiQXJyYXkiLCJpIiwibGVuIiwibGVuZ3RoIiwiT2JqZWN0IiwiYXR0ciIsImhhc093blByb3BlcnR5IiwiaXNGdW5jdGlvbiIsInRoaW5nVG9DaGVjayIsInRvU3RyaW5nIiwiY2FsbCIsIkVudGl0eU1hbmFnZXIiLCJsaXN0ZW5lciIsImVtaXQiLCJlbnRpdGllcyIsImNvbXBvbmVudHMiLCJhc3NlbWJsYWdlcyIsImVudGl0eUNvbXBvbmVudERhdGEiLCJwcm9jZXNzb3JzIiwidWlkIiwidGhpcyIsImNvbXBvbmVudElkcyIsImVudGl0eUlkIiwiZ2V0VWlkIiwiYWRkQ29tcG9uZW50c1RvRW50aXR5IiwiaW5jbHVkZXMiLCJwdXNoIiwiaWQiLCJjb21wIiwic3BsaWNlIiwiaW5kZXhPZiIsImNvbXBvbmVudCIsImtleXMiLCJzZWxmIiwiRXJyb3IiLCJuZXdDb21wU3RhdGUiLCJzdGF0ZSIsInByb3BlcnR5IiwiZGVmaW5lUHJvcGVydHkiLCJ2YWwiLCJfX2lkIiwiY29tcG9uZW50SWQiLCJuZXdTdGF0ZSIsImNvbXBTdGF0ZSIsImdldENvbXBvbmVudERhdGFGb3JFbnRpdHkiLCJrZXkiLCJhc3NlbWJsYWdlIiwiYXNzZW1ibGFnZUlkIiwiZW50aXR5IiwiY3JlYXRlRW50aXR5IiwiaW5pdGlhbFN0YXRlIiwidXBkYXRlQ29tcG9uZW50RGF0YUZvckVudGl0eSIsInByb2Nlc3NvciIsImR0IiwidXBkYXRlIl0sIm1hcHBpbmdzIjoiK0tBZUEsU0FBU0EsR0FBTUMsTUFFUCxNQUFRQSxHQUFPLDhCQUFtQkEsaUJBQUFBLElBQUssTUFBT0EsTUFFOUNDLE1BR0FELFlBQWVFLGVBQ1IsR0FBSUEsUUFDTkMsUUFBUUgsRUFBSUksV0FDVkgsS0FJUEQsWUFBZUssT0FBTyxVQUVqQixHQUFJQyxHQUFJLEVB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
