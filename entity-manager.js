!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.ensy=e()}(this,function(){"use strict";function t(e){if(null==e||"object"!=(void 0===e?"undefined":n(e)))return e;var o;if(e instanceof Date)return o=new Date,o.setTime(e.getTime()),o;if(e instanceof Array){o=[];for(var i=0,r=e.length;i<r;i++)o[i]=t(e[i]);return o}if(e instanceof Object){o={};for(var s in e)e.hasOwnProperty(s)&&(o[s]=t(e[s]));return o}}function e(t){return t&&"[object Function]"==={}.toString.call(t)}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}();return function(){function n(t){o(this,n),this.listener=null,t&&e(t.emit)&&(this.listener=t),this.entities=[],this.components={},this.assemblages={},this.entityComponentData={},this.processors=[],this.uid=0}return i(n,[{key:"getUid",value:function(){return this.uid++}},{key:"createEntity",value:function(t,e){return void 0===e||null===e?e=this.getUid():e>this.uid&&(this.uid=e),this.addComponentsToEntity(t,e),this.entities.includes(e)||this.entities.push(e),this.listener&&this.listener.emit("entityCreated",e),e}},{key:"removeEntity",value:function(t){for(var e in this.entityComponentData)this.entityComponentData.hasOwnProperty(e)&&this.entityComponentData[e][t]&&delete this.entityComponentData[e][t];return this.entities.splice(this.entities.indexOf(t),1),this.listener&&this.listener.emit("entityCreated",t),this}},{key:"addComponent",value:function(t,e){return this.components[t]=e,this}},{key:"removeComponent",value:function(t){return delete this.components[t],delete this.entityComponentData[t],this}},{key:"getComponentsList",value:function(){return Object.keys(this.components)}},{key:"addComponentsToEntity",value:function(e,n){var o,i,r=this;for(o=e.length-1;o>=0;o--)if(i=e[o],!this.components[i])throw new Error("Trying to use unknown component: "+i);for(o=e.length-1;o>=0;o--){i=e[o],this.entityComponentData[i]||(this.entityComponentData[i]={});var s=null;r.listener?(s={},function(e){var o=t(r.components[i].state);for(var s in o)o.hasOwnProperty(s)&&function(t){Object.defineProperty(e,t,{enumerable:!0,get:function(){return o[t]},set:function(e){o[t]=e,r.listener.emit("entityComponentUpdated",n,i)}})}(s)}(s),r.listener.emit("entityComponentAdded",n,i)):s=t(r.components[i].state),s.__id=n,this.entityComponentData[i][n]=s}return this}},{key:"removeComponentsFromEntity",value:function(t,e){var n,o;for(n=t.length-1;n>=0;n--)if(o=t[n],!this.components[o])throw new Error("Trying to use unknown component: "+o);for(n=t.length-1;n>=0;n--)o=t[n],this.entityComponentData[o]&&this.entityComponentData[o][e]&&(delete this.entityComponentData[o][e],this.listener&&this.listener.emit("entityComponentRemoved",e,o));return this}},{key:"getComponentDataForEntity",value:function(t,e){if(!(t in this.components))throw new Error("Trying to use unknown component: "+t);if(!this.entityComponentData.hasOwnProperty(t)||!this.entityComponentData[t].hasOwnProperty(e))throw new Error("No data for component "+t+" and entity "+e);return this.entityComponentData[t][e]}},{key:"updateComponentDataForEntity",value:function(t,e,n){var o=this.getComponentDataForEntity(t,e);for(var i in n)n.hasOwnProperty(i)&&o.hasOwnProperty(i)&&(o[i]=n[i]);return this}},{key:"getComponentsData",value:function(t){if(!(t in this.components))throw new Error("Trying to use unknown component: "+t);return this.entityComponentData.hasOwnProperty(t)?this.entityComponentData[t]:[]}},{key:"entityHasComponent",value:function(t,e){return e in this.components&&(this.entityComponentData.hasOwnProperty(e)&&this.entityComponentData[e].hasOwnProperty(t))}},{key:"addAssemblage",value:function(t,e){return this.assemblages[t]=e,this}},{key:"removeAssemblage",value:function(t){return delete this.assemblages[t],this}},{key:"createEntityFromAssemblage",value:function(t){if(!(t in this.assemblages))throw new Error("Trying to use unknown assemblage: "+t);var e=this.assemblages[t],n=this.createEntity(e.components);for(var o in e.initialState)if(e.initialState.hasOwnProperty(o)){var i=e.initialState[o];this.updateComponentDataForEntity(o,n,i)}return n}},{key:"addProcessor",value:function(t){return this.processors.push(t),this}},{key:"removeProcessor",value:function(t){return this.processors.splice(this.processors.indexOf(t),1),this}},{key:"update",value:function(t){for(var e=0;e<this.processors.length;e++)this.processors[e].update(t);return this}}]),n}()});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LW1hbmFnZXIuanMiLCJzb3VyY2VzIjpbInNyYy9lbnRpdHktbWFuYWdlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIGVuc3kgLSBFbnRpdHkgU3lzdGVtIEphdmFTY3JpcHQgTGlicmFyeSB2MS4yLjFcbiAqXG4gKiBBIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24gb2YgdGhlIEVudGl0eSBTeXN0ZW0gbW9kZWwgYXMgZGVzY3JpYmVkIGJ5XG4gKiBBZGFtIE1hcnRpbiBpbiBodHRwOi8vdC1tYWNoaW5lLm9yZy9pbmRleC5waHAvMjAwOS8xMC8yNi9lbnRpdHktc3lzdGVtcy1hcmUtdGhlLWZ1dHVyZS1vZi1tbW9zLXBhcnQtNS9cbiAqXG4gKiBAYXV0aG9yIEFkcmlhbiBHYXVkZWJlcnQgLSBhZHJpYW5AZ2F1ZGViZXJ0LmZyXG4gKiBAbGljZW5zZSBNSVQgbGljZW5zZS5cbiAqXG4gKi9cblxuLyohXG4gKiBSZXR1cm4gYSBjbG9uZSBvZiBhbiBvYmplY3QuXG4gKiBGcm9tIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzcyODM2MFxuICovXG5mdW5jdGlvbiBjbG9uZShvYmopIHtcbiAgICAvLyBIYW5kbGUgdGhlIDMgc2ltcGxlIHR5cGVzLCBhbmQgbnVsbCBvciB1bmRlZmluZWRcbiAgICBpZiAobnVsbCA9PSBvYmogfHwgJ29iamVjdCcgIT0gdHlwZW9mIG9iaikgcmV0dXJuIG9iajtcblxuICAgIHZhciBjb3B5O1xuXG4gICAgLy8gSGFuZGxlIERhdGVcbiAgICBpZiAob2JqIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICBjb3B5ID0gbmV3IERhdGUoKTtcbiAgICAgICAgY29weS5zZXRUaW1lKG9iai5nZXRUaW1lKCkpO1xuICAgICAgICByZXR1cm4gY29weTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgQXJyYXlcbiAgICBpZiAob2JqIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgY29weSA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gb2JqLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgICAgICBjb3B5W2ldID0gY2xvbmUob2JqW2ldKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29weTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgT2JqZWN0XG4gICAgaWYgKG9iaiBpbnN0YW5jZW9mIE9iamVjdCkge1xuICAgICAgICBjb3B5ID0ge307XG4gICAgICAgIGZvciAodmFyIGF0dHIgaW4gb2JqKSB7XG4gICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGF0dHIpKSBjb3B5W2F0dHJdID0gY2xvbmUob2JqW2F0dHJdKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29weTtcbiAgICB9XG59XG5cbi8qIVxuICogUmV0dXJuIHRydWUgaWYgdGhlIHBhcmFtZXRlciBpcyBhIGZ1bmN0aW9uLlxuICogRnJvbSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81OTk5OTk4XG4gKi9cbmZ1bmN0aW9uIGlzRnVuY3Rpb24odGhpbmdUb0NoZWNrKSB7XG4gICAgcmV0dXJuIHRoaW5nVG9DaGVjayAmJiAoe30pLnRvU3RyaW5nLmNhbGwodGhpbmdUb0NoZWNrKSA9PT0gJ1tvYmplY3QgRnVuY3Rpb25dJztcbn1cblxuLyoqXG4gKiBAY2xhc3MgRW50aXR5TWFuYWdlclxuICpcbiAqIEltcGxlbWVudCB0aGUgRW50aXR5IFN5c3RlbSBtb2RlbCBhbmQgcHJvdmlkZSB0b29scyB0byBlYXNpbHlcbiAqIGNyZWF0ZSBhbmQgbWFuaXB1bGF0ZSBFbnRpdGllcywgQ29tcG9uZW50cyBhbmQgUHJvY2Vzc29ycy5cbiAqL1xuY2xhc3MgRW50aXR5TWFuYWdlciB7XG4gICAgY29uc3RydWN0b3IobGlzdGVuZXIpIHtcbiAgICAgICAgdGhpcy5saXN0ZW5lciA9IG51bGw7XG4gICAgICAgIGlmIChsaXN0ZW5lciAmJiBpc0Z1bmN0aW9uKGxpc3RlbmVyLmVtaXQpKSB7XG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyID0gbGlzdGVuZXI7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBIGxpc3Qgb2YgZW50aXR5IElEcywgZWFjaCBiZWluZyBhIHNpbXBsZSBpbnRlZ2VyLlxuICAgICAgICB0aGlzLmVudGl0aWVzID0gW107XG5cbiAgICAgICAgLy8gQSBkaWN0aW9uYXJ5IG9mIGNvbXBvbmVudHMsIHdoZXJlIGtleXMgYXJlIHRoZSBuYW1lIG9mIGVhY2hcbiAgICAgICAgLy8gY29tcG9uZW50LiBDb21wb25lbnRzIGFyZSBvYmplY3RzIGNvbnRhaW5pbmc6XG4gICAgICAgIC8vICAqIG1ldGFkYXRhIChuYW1lLCBkZXNjcmlwdGlvbilcbiAgICAgICAgLy8gICogdGhlIGluaXRpYWwgc2V0IG9mIGRhdGEgdGhhdCBkZWZpbmVzIHRoZSBkZWZhdWx0IHN0YXRlIG9mIGFcbiAgICAgICAgLy8gICAgbmV3bHkgaW5zdGFuY2lhdGVkIGNvbXBvbmVudFxuICAgICAgICB0aGlzLmNvbXBvbmVudHMgPSB7fTtcblxuICAgICAgICAvLyBBIGRpY3Rpb25hcnkgb2YgYXNzZW1ibGFnZXMsIHdoZXJlIGtleXMgYXJlIHRoZSBuYW1lIG9mIGVhY2hcbiAgICAgICAgLy8gYXNzZW1ibGFnZS4gQXNzZW1ibGFnZXMgYXJlIG9iamVjdHMgY29udGFpbmluZzpcbiAgICAgICAgLy8gICogbWV0YWRhdGEgKG5hbWUsIGRlc2NyaXB0aW9uKVxuICAgICAgICAvLyAgKiBhIGxpc3Qgb2YgY29tcG9uZW50cyB0byBhZGQgdG8gdGhlIGVudGl0eVxuICAgICAgICAvLyAgKiBhbiBpbml0aWFsIHN0YXRlIGZvciBzb21lIGNvbXBvbmVudHMsIHRvIG92ZXJyaWRlIHRoZSBkZWZhdWx0c1xuICAgICAgICB0aGlzLmFzc2VtYmxhZ2VzID0ge307XG5cbiAgICAgICAgLyohXG4gICAgICAgICAqIEEgcmVsYXRpb25hbC1saWtlIGxpc3Qgb2YgZW50aXR5IHN0YXRlcy4gVGhlcmUgaXMgb25lIGxpbmUgZm9yXG4gICAgICAgICAqIGVhY2ggZW50aXR5IC0gY29tcG9uZW50IGFzc29jaWF0aW9uLlxuICAgICAgICAgKlxuICAgICAgICAgKiBUbyBvcHRpbWl6ZSB0aGUgYWNjZXNzIHRpbWUgdG8gdGhpcyBkYXRhLCBpdCBpcyBzdG9yZWQgaW4gYVxuICAgICAgICAgKiBkaWN0aW9uYXJ5IG9mIGRpY3Rpb25hcmllcyBvZiB0aGlzIGZvcm06XG4gICAgICAgICAqIHtcbiAgICAgICAgICogICBcImNvbXBvbmVudElkXCI6IHtcbiAgICAgICAgICogICAgIFwiZW50aXR5SWRcIjoge1xuICAgICAgICAgKiAgICAgICAuLi5cbiAgICAgICAgICogICAgICAgaGVyZSBjb21lcyB0aGUgc3RhdGUgb2YgdGhpcyBlbnRpdHkgZm9yIHRoaXMgY29tcG9uZW50XG4gICAgICAgICAqICAgICAgIC4uLlxuICAgICAgICAgKiAgICAgfVxuICAgICAgICAgKiAgIH1cbiAgICAgICAgICogfVxuICAgICAgICAgKlxuICAgICAgICAgKiBUaGlzIHdheSwgZ2V0dGluZyB0aGUgZGF0YSBvZiBvbmUgZW50aXR5IGZvciBvbmUgY29tcG9uZW50IGlzOlxuICAgICAgICAgKiAgIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wb25lbnRJZF1bZW50aXR5SWRdXG4gICAgICAgICAqIGFuZCBnZXR0aW5nIGFsbCBlbnRpdGllcyBmb3Igb25lIGNvbXBvbmVudCBpczpcbiAgICAgICAgICogICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcG9uZW50SWRdXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGEgPSB7fTtcblxuICAgICAgICAvLyBUaGUgb3JkZXJlZCBsaXN0IG9mIHByb2Nlc3NvcnMga25vd24gYnkgdGhpcyBtYW5hZ2VyLlxuICAgICAgICB0aGlzLnByb2Nlc3NvcnMgPSBbXTtcblxuICAgICAgICAvLyBUaGUgbmV4dCB1bmlxdWUgaWRlbnRpZmllci5cbiAgICAgICAgdGhpcy51aWQgPSAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhbiBpZGVudGlmaWVyIHVuaXF1ZSB0byB0aGlzIHN5c3RlbS5cbiAgICAgKlxuICAgICAqIEByZXR1cm4ge2ludH0gLSBVbmlxdWUgaWRlbnRpZmllci5cbiAgICAgKi9cbiAgICBnZXRVaWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnVpZCsrO1xuICAgIH1cblxuICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIEVOVElUSUVTXG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5IGluIHRoZSBzeXN0ZW0gYnkgY3JlYXRpbmcgYSBuZXcgaW5zdGFuY2Ugb2YgZWFjaCBvZlxuICAgICAqIGl0cyBjb21wb25lbnRzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHthcnJheX0gY29tcG9uZW50SWRzIC0gTGlzdCBvZiBpZGVudGlmaWVycyBvZiB0aGUgY29tcG9uZW50cyB0aGF0IGNvbXBvc2UgdGhlIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gT3B0aW9uYWwuIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBlbnRpdHkuIElmIHBhc3NlZCwgbm8gbmV3IGlkIHdpbGwgYmUgZ2VuZXJhdGVkLlxuICAgICAqIEByZXR1cm4ge2ludH0gLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbmV3IGVudGl0eS5cbiAgICAgKi9cbiAgICBjcmVhdGVFbnRpdHkoY29tcG9uZW50SWRzLCBlbnRpdHlJZCkge1xuICAgICAgICBpZiAodHlwZW9mIGVudGl0eUlkID09PSAndW5kZWZpbmVkJyB8fCBlbnRpdHlJZCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgZW50aXR5SWQgPSB0aGlzLmdldFVpZCgpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGVudGl0eUlkID4gdGhpcy51aWQpIHtcbiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSBhbm90aGVyIGVudGl0eSB3aXRoIHRoZSBzYW1lIElEIHdvbid0IGJlIGNyZWF0ZWQgaW4gdGhlIGZ1dHVyZS5cbiAgICAgICAgICAgIHRoaXMudWlkID0gZW50aXR5SWQ7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmFkZENvbXBvbmVudHNUb0VudGl0eShjb21wb25lbnRJZHMsIGVudGl0eUlkKTtcbiAgICAgICAgaWYgKCF0aGlzLmVudGl0aWVzLmluY2x1ZGVzKGVudGl0eUlkKSkge1xuICAgICAgICAgICAgdGhpcy5lbnRpdGllcy5wdXNoKGVudGl0eUlkKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5saXN0ZW5lcikge1xuICAgICAgICAgICAgLy8gU2lnbmFsIHRoZSBjcmVhdGlvbiBvZiBhIG5ldyBlbnRpdHkuXG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLmVtaXQoJ2VudGl0eUNyZWF0ZWQnLCBlbnRpdHlJZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVudGl0eUlkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBlbnRpdHkgYW5kIGl0cyBpbnN0YW5jaWF0ZWQgY29tcG9uZW50cyBmcm9tIHRoZSBzeXN0ZW0uXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ludH0gaWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgZW50aXR5LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgcmVtb3ZlRW50aXR5KGlkKSB7XG4gICAgICAgIC8vIFJlbW92ZSBhbGwgZGF0YSBmb3IgdGhpcyBlbnRpdHkuXG4gICAgICAgIGZvciAodmFyIGNvbXAgaW4gdGhpcy5lbnRpdHlDb21wb25lbnREYXRhKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5lbnRpdHlDb21wb25lbnREYXRhLmhhc093blByb3BlcnR5KGNvbXApKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXVtpZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXVtpZF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmVtb3ZlIHRoZSBlbnRpdHkgZnJvbSB0aGUgbGlzdCBvZiBrbm93biBlbnRpdGllcy5cbiAgICAgICAgdGhpcy5lbnRpdGllcy5zcGxpY2UodGhpcy5lbnRpdGllcy5pbmRleE9mKGlkKSwgMSk7XG5cbiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXIpIHtcbiAgICAgICAgICAgIC8vIFNpZ25hbCB0aGUgcmVtb3ZhbCBvZiBhbiBlbnRpdHkuXG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLmVtaXQoJ2VudGl0eUNyZWF0ZWQnLCBpZCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyBDT01QT05FTlRTXG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBjb21wb25lbnQgdG8gdGhlIGxpc3Qgb2Yga25vd24gY29tcG9uZW50cy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBjb21wb25lbnQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbXBvbmVudCAtIE9iamVjdCBjb250YWluaW5nIHRoZSBtZXRhZGF0YSBhbmQgZGF0YSBvZiB0aGUgY29tcG9uZW50LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgYWRkQ29tcG9uZW50KGlkLCBjb21wb25lbnQpIHtcbiAgICAgICAgdGhpcy5jb21wb25lbnRzW2lkXSA9IGNvbXBvbmVudDtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGEgY29tcG9uZW50IGZyb20gdGhlIGxpc3Qgb2Yga25vd24gY29tcG9uZW50cy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBjb21wb25lbnQuXG4gICAgICogQHJldHVybiB7b2JqZWN0fSAtIHRoaXNcbiAgICAgKi9cbiAgICByZW1vdmVDb21wb25lbnQoaWQpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuY29tcG9uZW50c1tpZF07XG4gICAgICAgIGRlbGV0ZSB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbaWRdO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGxpc3Qgb2YgY29tcG9uZW50cyB0aGlzIGluc3RhbmNlIGtub3dzLlxuICAgICAqXG4gICAgICogQHJldHVybiB7YXJyYXl9IC0gTGlzdCBvZiBuYW1lcyBvZiBjb21wb25lbnRzLlxuICAgICAqL1xuICAgIGdldENvbXBvbmVudHNMaXN0KCkge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5jb21wb25lbnRzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgZWFjaCBsaXN0ZWQgY29tcG9uZW50IGFuZCBhc3NvY2lhdGUgdGhlbVxuICAgICAqIHdpdGggdGhlIGVudGl0eS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGNvbXBvbmVudElkcyAtIExpc3Qgb2YgaWRlbnRpZmllcnMgb2YgdGhlIGNvbXBvbmVudHMgdG8gYWRkIHRvIHRoZSBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGVudGl0eS5cbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IC0gdGhpc1xuICAgICAqL1xuICAgIGFkZENvbXBvbmVudHNUb0VudGl0eShjb21wb25lbnRJZHMsIGVudGl0eUlkKSB7XG4gICAgICAgIHZhciBpO1xuICAgICAgICB2YXIgY29tcDtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIC8vIEZpcnN0IHZlcmlmeSB0aGF0IGFsbCB0aGUgY29tcG9uZW50cyBleGlzdCwgYW5kIHRocm93IGFuIGVycm9yXG4gICAgICAgIC8vIGlmIGFueSBpcyB1bmtub3duLlxuICAgICAgICBmb3IgKGkgPSBjb21wb25lbnRJZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgIGNvbXAgPSBjb21wb25lbnRJZHNbaV07XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5jb21wb25lbnRzW2NvbXBdKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gdXNlIHVua25vd24gY29tcG9uZW50OiAnICsgY29tcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBOb3cgd2Uga25vdyB0aGF0IHRoaXMgcmVxdWVzdCBpcyBjb3JyZWN0LCBsZXQncyBjcmVhdGUgdGhlIG5ld1xuICAgICAgICAvLyBlbnRpdHkgYW5kIGluc3RhbmNpYXRlIHRoZSBjb21wb25lbnQncyBzdGF0ZXMuXG4gICAgICAgIGZvciAoaSA9IGNvbXBvbmVudElkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICAgICAgY29tcCA9IGNvbXBvbmVudElkc1tpXTtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcF0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcF0gPSB7fTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIG5ld0NvbXBTdGF0ZSA9IG51bGw7XG5cbiAgICAgICAgICAgIC8vIElmIHRoZSBtYW5hZ2VyIGhhcyBhIGxpc3RlbmVyLCB3ZSB3YW50IHRvIGNyZWF0ZSBnZXR0ZXJzXG4gICAgICAgICAgICAvLyBhbmQgc2V0dGVycyBzbyB0aGF0IHdlIGNhbiBlbWl0IHN0YXRlIGNoYW5nZXMuIEJ1dCBpZiBpdCBkb2VzXG4gICAgICAgICAgICAvLyBub3QgaGF2ZSBvbmUsIHRoZXJlIGlzIG5vIG5lZWQgdG8gYWRkIHRoZSBvdmVyaGVhZC5cbiAgICAgICAgICAgIGlmIChzZWxmLmxpc3RlbmVyKSB7XG4gICAgICAgICAgICAgICAgbmV3Q29tcFN0YXRlID0ge307XG4gICAgICAgICAgICAgICAgKGZ1bmN0aW9uIChuZXdDb21wU3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gY2xvbmUoc2VsZi5jb21wb25lbnRzW2NvbXBdLnN0YXRlKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgYSBzZXR0ZXIgZm9yIGVhY2ggc3RhdGUgYXR0cmlidXRlLCBzbyB3ZSBjYW4gZW1pdCBhblxuICAgICAgICAgICAgICAgICAgICAvLyBldmVudCB3aGVuZXZlciB0aGUgc3RhdGUgb2YgdGhpcyBjb21wb25lbnQgY2hhbmdlcy5cbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgcHJvcGVydHkgaW4gc3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKHByb3BlcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuZXdDb21wU3RhdGUsIHByb3BlcnR5LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlW3Byb3BlcnR5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVtwcm9wZXJ0eV0gPSB2YWw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5saXN0ZW5lci5lbWl0KCdlbnRpdHlDb21wb25lbnRVcGRhdGVkJywgZW50aXR5SWQsIGNvbXApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkocHJvcGVydHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSkobmV3Q29tcFN0YXRlKTtcblxuICAgICAgICAgICAgICAgIC8vIFNpZ25hbCB0aGUgYWRkaXRpb24gb2YgYSBuZXcgY29tcG9uZW50IHRvIHRoZSBlbnRpdHkuXG4gICAgICAgICAgICAgICAgc2VsZi5saXN0ZW5lci5lbWl0KCdlbnRpdHlDb21wb25lbnRBZGRlZCcsIGVudGl0eUlkLCBjb21wKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIG5ld0NvbXBTdGF0ZSA9IGNsb25lKHNlbGYuY29tcG9uZW50c1tjb21wXS5zdGF0ZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFN0b3JlIHRoZSBlbnRpdHkncyBJRCBzbyBpdCdzIGVhc2llciB0byBmaW5kIG90aGVyIGNvbXBvbmVudHMgZm9yIHRoYXQgZW50aXR5LlxuICAgICAgICAgICAgbmV3Q29tcFN0YXRlLl9faWQgPSBlbnRpdHlJZDtcblxuICAgICAgICAgICAgdGhpcy5lbnRpdHlDb21wb25lbnREYXRhW2NvbXBdW2VudGl0eUlkXSA9IG5ld0NvbXBTdGF0ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlLWFzc29jaWF0ZSBhIGxpc3Qgb2YgY29tcG9uZW50cyBmcm9tIHRoZSBlbnRpdHkuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBjb21wb25lbnRJZHMgLSBMaXN0IG9mIGlkZW50aWZpZXJzIG9mIHRoZSBjb21wb25lbnRzIHRvIHJlbW92ZSBmcm9tIHRoZSBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGVudGl0eS5cbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IC0gdGhpc1xuICAgICAqL1xuICAgIHJlbW92ZUNvbXBvbmVudHNGcm9tRW50aXR5KGNvbXBvbmVudElkcywgZW50aXR5SWQpIHtcbiAgICAgICAgdmFyIGk7XG4gICAgICAgIHZhciBjb21wO1xuXG4gICAgICAgIC8vIEZpcnN0IHZlcmlmeSB0aGF0IGFsbCB0aGUgY29tcG9uZW50cyBleGlzdCwgYW5kIHRocm93IGFuIGVycm9yXG4gICAgICAgIC8vIGlmIGFueSBpcyB1bmtub3duLlxuICAgICAgICBmb3IgKGkgPSBjb21wb25lbnRJZHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgIGNvbXAgPSBjb21wb25lbnRJZHNbaV07XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5jb21wb25lbnRzW2NvbXBdKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gdXNlIHVua25vd24gY29tcG9uZW50OiAnICsgY29tcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBOb3cgd2Uga25vdyB0aGF0IHRoaXMgcmVxdWVzdCBpcyBjb3JyZWN0LCBsZXQncyBjcmVhdGUgdGhlIG5ld1xuICAgICAgICAvLyBlbnRpdHkgYW5kIGluc3RhbmNpYXRlIHRoZSBjb21wb25lbnQncyBzdGF0ZXMuXG4gICAgICAgIGZvciAoaSA9IGNvbXBvbmVudElkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICAgICAgY29tcCA9IGNvbXBvbmVudElkc1tpXTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wXSkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcF1bZW50aXR5SWRdKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcF1bZW50aXR5SWRdO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5saXN0ZW5lcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2lnbmFsIHRoZSBjcmVhdGlvbiBvZiBhIG5ldyBlbnRpdHkuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVyLmVtaXQoJ2VudGl0eUNvbXBvbmVudFJlbW92ZWQnLCBlbnRpdHlJZCwgY29tcCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBhIHJlZmVyZW5jZSB0byBhbiBvYmplY3QgdGhhdCBjb250YWlucyB0aGUgZGF0YSBvZiBhblxuICAgICAqIGluc3RhbmNpYXRlZCBjb21wb25lbnQgb2YgYW4gZW50aXR5LlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbnR9IGVudGl0eUlkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50SWQgLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgY29tcG9uZW50LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSBDb21wb25lbnQgZGF0YSBvZiBvbmUgZW50aXR5LlxuICAgICAqL1xuICAgIGdldENvbXBvbmVudERhdGFGb3JFbnRpdHkoY29tcG9uZW50SWQsIGVudGl0eUlkKSB7XG4gICAgICAgIGlmICghKGNvbXBvbmVudElkIGluIHRoaXMuY29tcG9uZW50cykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHVzZSB1bmtub3duIGNvbXBvbmVudDogJyArIGNvbXBvbmVudElkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgICF0aGlzLmVudGl0eUNvbXBvbmVudERhdGEuaGFzT3duUHJvcGVydHkoY29tcG9uZW50SWQpIHx8XG4gICAgICAgICAgICAhdGhpcy5lbnRpdHlDb21wb25lbnREYXRhW2NvbXBvbmVudElkXS5oYXNPd25Qcm9wZXJ0eShlbnRpdHlJZClcbiAgICAgICAgKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGRhdGEgZm9yIGNvbXBvbmVudCAnICsgY29tcG9uZW50SWQgKyAnIGFuZCBlbnRpdHkgJyArIGVudGl0eUlkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcG9uZW50SWRdW2VudGl0eUlkXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgdGhlIHN0YXRlIG9mIGEgY29tcG9uZW50LCBtYW55IGtleXMgYXQgb25jZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW50fSBlbnRpdHlJZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbXBvbmVudElkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGNvbXBvbmVudC5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gbmV3U3RhdGUgLSBPYmplY3QgY29udGFpbmluZyB0aGUgbmV3IHN0YXRlIHRvIGFwcGx5LlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgdXBkYXRlQ29tcG9uZW50RGF0YUZvckVudGl0eShjb21wb25lbnRJZCwgZW50aXR5SWQsIG5ld1N0YXRlKSB7XG4gICAgICAgIHZhciBjb21wU3RhdGUgPSB0aGlzLmdldENvbXBvbmVudERhdGFGb3JFbnRpdHkoY29tcG9uZW50SWQsIGVudGl0eUlkKTtcblxuICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmV3U3RhdGUpIHtcbiAgICAgICAgICAgIGlmIChuZXdTdGF0ZS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGNvbXBTdGF0ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgY29tcFN0YXRlW2tleV0gPSBuZXdTdGF0ZVtrZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIGEgbGlzdCBvZiBvYmplY3RzIGNvbnRhaW5pbmcgdGhlIGRhdGEgb2YgYWxsIG9mIGEgZ2l2ZW4gY29tcG9uZW50LlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbXBvbmVudElkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGNvbXBvbmVudC5cbiAgICAgKiBAcmV0dXJuIHthcnJheX0gLSBMaXN0IG9mIGNvbXBvbmVudCBkYXRhIGZvciBvbmUgY29tcG9uZW50LlxuICAgICAqL1xuICAgIGdldENvbXBvbmVudHNEYXRhKGNvbXBvbmVudElkKSB7XG4gICAgICAgIGlmICghKGNvbXBvbmVudElkIGluIHRoaXMuY29tcG9uZW50cykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHVzZSB1bmtub3duIGNvbXBvbmVudDogJyArIGNvbXBvbmVudElkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5lbnRpdHlDb21wb25lbnREYXRhLmhhc093blByb3BlcnR5KGNvbXBvbmVudElkKSkge1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZW50aXR5Q29tcG9uZW50RGF0YVtjb21wb25lbnRJZF07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIHRydWUgaWYgdGhlIGVudGl0eSBoYXMgdGhlIGNvbXBvbmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW50fSBlbnRpdHlJZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbXBvbmVudElkIC0gVW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGNvbXBvbmVudC5cbiAgICAgKiBAcmV0dXJuIHtib29sZWFufSAtIFRydWUgaWYgdGhlIGVudGl0eSBoYXMgdGhlIGNvbXBvbmVudC5cbiAgICAgKi9cbiAgICBlbnRpdHlIYXNDb21wb25lbnQoZW50aXR5SWQsIGNvbXBvbmVudElkKSB7XG4gICAgICAgIGlmICghKGNvbXBvbmVudElkIGluIHRoaXMuY29tcG9uZW50cykpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGEuaGFzT3duUHJvcGVydHkoY29tcG9uZW50SWQpICYmXG4gICAgICAgICAgICB0aGlzLmVudGl0eUNvbXBvbmVudERhdGFbY29tcG9uZW50SWRdLmhhc093blByb3BlcnR5KGVudGl0eUlkKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIEFTU0VNQkxBR0VTXG5cbiAgICAvKipcbiAgICAgKiBBZGQgYW4gYXNzZW1ibGFnZSB0byB0aGUgbGlzdCBvZiBrbm93biBhc3NlbWJsYWdlcy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBhc3NlbWJsYWdlLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBhc3NlbWJsYWdlIC0gQW4gaW5zdGFuY2Ugb2YgYW4gYXNzZW1ibGFnZSB0byBhZGQuXG4gICAgICogQHJldHVybiB7b2JqZWN0fSAtIHRoaXNcbiAgICAgKi9cbiAgICBhZGRBc3NlbWJsYWdlKGlkLCBhc3NlbWJsYWdlKSB7XG4gICAgICAgIHRoaXMuYXNzZW1ibGFnZXNbaWRdID0gYXNzZW1ibGFnZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGFzc2VtYmxhZ2UgZnJvbSB0aGUgbGlzdCBvZiBrbm93biBhc3NlbWJsYWdlcy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBhc3NlbWJsYWdlLlxuICAgICAqIEByZXR1cm4ge29iamVjdH0gLSB0aGlzXG4gICAgICovXG4gICAgcmVtb3ZlQXNzZW1ibGFnZShpZCkge1xuICAgICAgICBkZWxldGUgdGhpcy5hc3NlbWJsYWdlc1tpZF07XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkgaW4gdGhlIHN5c3RlbSBieSBjcmVhdGluZyBhIG5ldyBpbnN0YW5jZSBvZiBlYWNoIG9mXG4gICAgICogaXRzIGNvbXBvbmVudHMgYW5kIHNldHRpbmcgdGhlaXIgaW5pdGlhbCBzdGF0ZSwgdXNpbmcgYW4gYXNzZW1ibGFnZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhc3NlbWJsYWdlSWQgLSBJZCBvZiB0aGUgYXNzZW1ibGFnZSB0byBjcmVhdGUgdGhlIGVudGl0eSBmcm9tLlxuICAgICAqIEByZXR1cm4ge2ludH0gLSBVbmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbmV3IGVudGl0eS5cbiAgICAgKi9cbiAgICBjcmVhdGVFbnRpdHlGcm9tQXNzZW1ibGFnZShhc3NlbWJsYWdlSWQpIHtcbiAgICAgICAgaWYgKCEoYXNzZW1ibGFnZUlkIGluIHRoaXMuYXNzZW1ibGFnZXMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byB1c2UgdW5rbm93biBhc3NlbWJsYWdlOiAnICsgYXNzZW1ibGFnZUlkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBhc3NlbWJsYWdlID0gdGhpcy5hc3NlbWJsYWdlc1thc3NlbWJsYWdlSWRdO1xuICAgICAgICB2YXIgZW50aXR5ID0gdGhpcy5jcmVhdGVFbnRpdHkoYXNzZW1ibGFnZS5jb21wb25lbnRzKTtcblxuICAgICAgICBmb3IgKHZhciBjb21wIGluIGFzc2VtYmxhZ2UuaW5pdGlhbFN0YXRlKSB7XG4gICAgICAgICAgICBpZiAoYXNzZW1ibGFnZS5pbml0aWFsU3RhdGUuaGFzT3duUHJvcGVydHkoY29tcCkpIHtcbiAgICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBhc3NlbWJsYWdlLmluaXRpYWxTdGF0ZVtjb21wXTtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUNvbXBvbmVudERhdGFGb3JFbnRpdHkoY29tcCwgZW50aXR5LCBuZXdTdGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZW50aXR5O1xuICAgIH1cblxuICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIFBST0NFU1NPUlNcblxuICAgIC8qKlxuICAgICAqIEFkZCBhIHByb2Nlc3NvciB0byB0aGUgbGlzdCBvZiBrbm93biBwcm9jZXNzb3JzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHByb2Nlc3NvciAtIEFuIGluc3RhbmNlIG9mIGEgcHJvY2Vzc29yIHRvIG1hbmFnZS5cbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IC0gdGhpc1xuICAgICAqL1xuICAgIGFkZFByb2Nlc3Nvcihwcm9jZXNzb3IpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzb3JzLnB1c2gocHJvY2Vzc29yKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGEgcHJvY2Vzc29yIGZyb20gdGhlIGxpc3Qgb2Yga25vd24gcHJvY2Vzc29ycy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwcm9jZXNzb3IgLSBBbiBpbnN0YW5jZSBvZiBhIHByb2Nlc3NvciB0byByZW1vdmUuXG4gICAgICogQHJldHVybiB7b2JqZWN0fSAtIHRoaXNcbiAgICAgKi9cbiAgICByZW1vdmVQcm9jZXNzb3IocHJvY2Vzc29yKSB7XG4gICAgICAgIHRoaXMucHJvY2Vzc29ycy5zcGxpY2UodGhpcy5wcm9jZXNzb3JzLmluZGV4T2YocHJvY2Vzc29yKSwgMSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbGwgdGhlIGtub3duIHByb2Nlc3NvcnMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2ludH0gZHQgLSBUaGUgdGltZSBkZWx0YSBzaW5jZSB0aGUgbGFzdCBjYWxsIHRvIHVwZGF0ZS4gV2lsbCBiZSBwYXNzZWQgYXMgYW4gYXJndW1lbnQgdG8gYWxsIHByb2Nlc3NvcidzIGB1cGRhdGVgIG1ldGhvZC5cbiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IC0gdGhpc1xuICAgICAqL1xuICAgIHVwZGF0ZShkdCkge1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucHJvY2Vzc29ycy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzb3JzW2ldLnVwZGF0ZShkdCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBFbnRpdHlNYW5hZ2VyO1xuIl0sIm5hbWVzIjpbImNsb25lIiwib2JqIiwiY29weSIsIkRhdGUiLCJzZXRUaW1lIiwiZ2V0VGltZSIsIkFycmF5IiwiaSIsImxlbiIsImxlbmd0aCIsIk9iamVjdCIsImF0dHIiLCJoYXNPd25Qcm9wZXJ0eSIsImlzRnVuY3Rpb24iLCJ0aGluZ1RvQ2hlY2siLCJ0b1N0cmluZyIsImNhbGwiLCJsaXN0ZW5lciIsImVtaXQiLCJlbnRpdGllcyIsImNvbXBvbmVudHMiLCJhc3NlbWJsYWdlcyIsImVudGl0eUNvbXBvbmVudERhdGEiLCJwcm9jZXNzb3JzIiwidWlkIiwidGhpcyIsImNvbXBvbmVudElkcyIsImVudGl0eUlkIiwiZ2V0VWlkIiwiYWRkQ29tcG9uZW50c1RvRW50aXR5IiwiaW5jbHVkZXMiLCJwdXNoIiwiaWQiLCJjb21wIiwic3BsaWNlIiwiaW5kZXhPZiIsImNvbXBvbmVudCIsImtleXMiLCJzZWxmIiwiRXJyb3IiLCJuZXdDb21wU3RhdGUiLCJzdGF0ZSIsInByb3BlcnR5IiwiZGVmaW5lUHJvcGVydHkiLCJ2YWwiLCJfX2lkIiwiY29tcG9uZW50SWQiLCJuZXdTdGF0ZSIsImNvbXBTdGF0ZSIsImdldENvbXBvbmVudERhdGFGb3JFbnRpdHkiLCJrZXkiLCJhc3NlbWJsYWdlIiwiYXNzZW1ibGFnZUlkIiwiZW50aXR5IiwiY3JlYXRlRW50aXR5IiwiaW5pdGlhbFN0YXRlIiwidXBkYXRlQ29tcG9uZW50RGF0YUZvckVudGl0eSIsInByb2Nlc3NvciIsImR0IiwidXBkYXRlIl0sIm1hcHBpbmdzIjoiK0tBZUEsU0FBU0EsR0FBTUMsTUFFUCxNQUFRQSxHQUFPLG9CQUFtQkEsZ0JBQUFBLElBQUssTUFBT0EsTUFFOUNDLE1BR0FELFlBQWVFLGVBQ1IsR0FBSUEsUUFDTkMs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
